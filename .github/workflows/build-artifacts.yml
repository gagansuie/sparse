name: Build Proprietary Package

# IMPORTANT: This builds PROPRIETARY software for sale to HuggingFace
# NOT for public distribution or PyPI

on:
  push:
    branches: [main]
    tags: ['v*']
  workflow_dispatch:

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install -e ".[dev]"
      
      - name: Run tests
        run: |
          python scripts/test_all_features.py
      
      - name: Test CLI
        run: |
          sparse --help
          sparse delta --help
          sparse optimize --help

  build:
    name: Build Package
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install build tools
        run: pip install build twine
      
      - name: Build package
        run: python -m build
      
      - name: Check package
        run: twine check dist/*
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-package
          path: dist/

  build-deliverables:
    name: Build Deliverables Package for Client
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Download package artifacts
        uses: actions/download-artifact@v4
        with:
          name: python-package
          path: dist/
      
      - name: Build deliverables package
        run: |
          mkdir -p deliverables/${{ github.ref_name }}
          
          # 1. Source code (full library)
          cp -r core deliverables/${{ github.ref_name }}/
          cp -r optimizer deliverables/${{ github.ref_name }}/
          cp -r cli deliverables/${{ github.ref_name }}/
          cp pyproject.toml deliverables/${{ github.ref_name }}/
          cp README.md deliverables/${{ github.ref_name }}/
          cp LICENSE deliverables/${{ github.ref_name }}/
          cp DELIVERABLES_CHECKLIST.md deliverables/${{ github.ref_name }}/ 2>/dev/null || true
          
          # 2. Built wheels
          cp -r dist deliverables/${{ github.ref_name }}/
          
          # 3. Documentation
          cp -r docs deliverables/${{ github.ref_name }}/
          cp -r examples deliverables/${{ github.ref_name }}/
          
          # 4. Tests
          cp -r tests deliverables/${{ github.ref_name }}/
          cp -r scripts deliverables/${{ github.ref_name }}/
          
          # 5. Create manifest
          cat > deliverables/${{ github.ref_name }}/DELIVERABLES.md << 'EOF'
          # Sparse Deliverables Package
          
          Version: ${{ github.ref_name }}
          Date: $(date -u +"%Y-%m-%d")
          
          ## Contents
          
          ### 1. Source Code
          - `core/` - Core delta compression and dataset delta modules
          - `optimizer/` - Cost optimizer and smart routing
          - `cli/` - Command-line interface
          - `pyproject.toml` - Package configuration
          
          ### 2. Pre-built Package
          - `dist/` - Python wheels (.whl) for pip install
          
          ### 3. Documentation
          - `docs/` - Full technical documentation
          - `examples/` - Usage examples
          - `README.md` - Quick start guide
          
          ### 4. Tests
          - `tests/` - Full test suite (pytest)
          - `scripts/` - Test runners and utilities
          
          ## Installation (HuggingFace Internal)
          
          ```bash
          # Option 1: Install from wheel
          pip install dist/sparse-*.whl
          
          # Option 2: Install from source
          pip install -e .
          ```
          
          ## Integration
          
          See `docs/INTEGRATION_GUIDE.md` for HuggingFace-specific integration.
          
          ## License
          
          PROPRIETARY SOFTWARE - Sparse Labs
          Licensed for HuggingFace internal use only.
          See LICENSE file for full terms.
          
          ## Contact
          
          Sparse Labs
          Email: gagan.suie@sparselabs.ai
          EOF
          
          # 6. Create tarball
          cd deliverables
          tar -czf sparse-${{ github.ref_name }}-deliverables.tar.gz ${{ github.ref_name }}/
          sha256sum sparse-${{ github.ref_name }}-deliverables.tar.gz > sparse-${{ github.ref_name }}-deliverables.tar.gz.sha256
      
      - name: Upload deliverables
        uses: actions/upload-artifact@v4
        with:
          name: client-deliverables
          path: deliverables/sparse-*.tar.gz*
          retention-days: 90
      
      - name: Create private release (manual approval required)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create ${{ github.ref_name }} \
            --title "Sparse ${{ github.ref_name }} - PROPRIETARY" \
            --notes "⚠️ PROPRIETARY SOFTWARE - For authorized clients only" \
            --draft \
            deliverables/sparse-*.tar.gz*
