name: Build Proprietary Package




on:
  push:
    branches: [main]
    tags: ['v*']
  workflow_dispatch:

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: Install lightweight dependencies
        run: |
          # Install package without heavy ML dependencies
          pip install --no-deps -e .
          pip install pytest black ruff tqdm
      
      - name: Run lightweight tests
        run: |
          python scripts/test_ci.py

  build:
    name: Build Package
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install build tools
        run: pip install build twine
      
      - name: Build package
        run: python -m build
      
      - name: Check package
        run: twine check dist/*
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-package
          path: dist/

  build-deliverables:
    name: Build Deliverables Package for Client
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Get version from pyproject.toml
        id: get_version
        run: |
          VERSION=$(grep -m 1 'version = ' pyproject.toml | cut -d'"' -f2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"
      
      - name: Download package artifacts
        uses: actions/download-artifact@v4
        with:
          name: python-package
          path: dist/
      
      - name: Build deliverables package
        run: |
          VERSION=${{ steps.get_version.outputs.version }}
          mkdir -p deliverables/v$VERSION
          
          # 1. Source code (full library)
          cp -r core deliverables/v$VERSION/
          cp -r optimizer deliverables/v$VERSION/
          cp -r cli deliverables/v$VERSION/
          cp pyproject.toml deliverables/v$VERSION/
          cp README.md deliverables/v$VERSION/
          cp LICENSE deliverables/v$VERSION/
          cp DELIVERABLES_CHECKLIST.md deliverables/v$VERSION/ 2>/dev/null || true
          
          # 2. Built wheels
          cp -r dist deliverables/v$VERSION/
          
          # 3. Documentation
          cp -r docs deliverables/v$VERSION/
          cp -r examples deliverables/v$VERSION/
          
          # 4. Tests
          cp -r tests deliverables/v$VERSION/
          cp -r scripts deliverables/v$VERSION/
          
          # 5. Create manifest
          cat > deliverables/v$VERSION/DELIVERABLES.md << EOF
          # Sparse Deliverables Package
          
          Version: v$VERSION
          Date: $(date -u +"%Y-%m-%d")
          Commit: ${{ github.sha }}
          Branch: ${{ github.ref_name }}
          
          ## Contents
          
          ### 1. Source Code
          - `core/` - Core delta compression and dataset delta modules
          - `optimizer/` - Cost optimizer and smart routing
          - `cli/` - Command-line interface
          - `pyproject.toml` - Package configuration
          
          ### 2. Pre-built Package
          - `dist/` - Python wheels (.whl) for pip install
          
          ### 3. Documentation
          - `docs/` - Full technical documentation
          - `examples/` - Usage examples
          - `README.md` - Quick start guide
          
          ### 4. Tests
          - `tests/` - Full test suite (pytest)
          - `scripts/` - Test runners and utilities
          
          ## Installation (HuggingFace Internal)
          
          ```bash
          # Option 1: Install from wheel
          pip install dist/sparse-*.whl
          
          # Option 2: Install from source
          pip install -e .
          ```
          
          ## Integration
          
          See `docs/INTEGRATION_GUIDE.md` for HuggingFace-specific integration.
          
          ## License
          
          PROPRIETARY SOFTWARE - Sparse Labs
          Licensed for HuggingFace internal use only.
          See LICENSE file for full terms.
          
          ## Contact
          
          Sparse Labs
          Email: gagan.suie@sparselabs.ai
          EOF
          
          # 6. Create tarball
          cd deliverables
          tar -czf sparse-v$VERSION-deliverables.tar.gz v$VERSION/
          sha256sum sparse-v$VERSION-deliverables.tar.gz > sparse-v$VERSION-deliverables.tar.gz.sha256
      
      - name: Upload deliverables
        uses: actions/upload-artifact@v4
        with:
          name: sparse-v${{ steps.get_version.outputs.version }}-deliverables
          path: deliverables/sparse-*.tar.gz*
          retention-days: 90
          overwrite: true
      
      - name: Create private release (only on tags)
        if: startsWith(github.ref, 'refs/tags/v')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=${{ steps.get_version.outputs.version }}
          gh release create v$VERSION \
            --title "Sparse v$VERSION - PROPRIETARY" \
            --notes "⚠️ PROPRIETARY SOFTWARE - For authorized clients only
          
          Commit: ${{ github.sha }}
          Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          " \
            --draft \
            deliverables/sparse-*.tar.gz*
